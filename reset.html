<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>איפוס סיסמה (קוד)</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>איפוס סיסמה</h1>
    <p>הזן/י את האימייל שלך, את קוד האימות בן 6 ספרות שקיבלת, ואת הסיסמה החדשה.</p>
    <form id="f">
      <input type="email" name="email" placeholder="אימייל" required />
      <input type="text" name="code" placeholder="קוד אימות (6 ספרות)" maxlength="6" inputmode="numeric" required />
      <input type="password" name="p1" placeholder="סיסמה חדשה (7–15 תווים, אותיות גדולות/קטנות, ספרות ותו מיוחד)" required />
      <input type="password" name="p2" placeholder="אישור סיסמה" required />
      <button type="submit">אפס סיסמה</button>
    </form>
    <div id="msg" class="mt-3"></div>
    <p class="mt-3"><a href="forgot.html">צריך קוד? שלח שוב</a></p>
    <p class="mt-3"><a href="login.html">חזרה להתחברות</a></p>
  </div>
<script>
const f = document.getElementById('f');
const msg = document.getElementById('msg');

f.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.textContent = '';
  const fd = new FormData(f);
  const email = (fd.get('email') || '').trim();
  const code  = (fd.get('code') || '').trim();
  const p1    = fd.get('p1');
  const p2    = fd.get('p2');

  if (p1 !== p2) {
    msg.textContent = 'הסיסמאות אינן תואמות.';
    return;
  }

  try {
    const r = await fetch('/api/reset-by-code', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ email, code, newPassword: p1 })
    });
    const data = await r.json();
    if (!r.ok) {
      msg.textContent = data.error || `שגיאת שרת (${r.status})`;
      return;
    }
    msg.textContent = 'הסיסמה עודכנה בהצלחה. ניתן להתחבר כעת.';
  } catch {
    msg.textContent = 'שגיאת רשת.';
  }
});
</script>
</body>
</html>
